"use strict";var GitFlowVisualize=function(){function e(e){for(var t=0;t<e.branches.length;t++){var r=e.branches[t],n=e.commits[r.latestChangeset];n?(n.labels=n.labels||[],n.labels.push(r.id),r.lastActivity=n.authorTimestamp):(e.openEnds.asap=e.openEnds.asap||[],e.openEnds.asap.push(r.latestChangeset))}}function t(){_.each(a.chronoCommits,function(e){delete a.commits[e].labels}),e(a)}function r(e){var t=this;t.id=e,t.name=e,t.commits=[];var r=null,n=[];t.combine=function(e){r=e,e.receive(t)},t.receive=function(e){n.push(e)},t.isVisible=function(){return null===r},t.renderPos=function(){return r?r.id:t.id};var i=function(){return n.concat(t)},s=function(e){var t=a.commits[e];return t&&t.visible===!0};t.firstVisible=function(){var e=_.findLast(t.commits,s);return a.commits[e]},t.lastVisible=function(){var e=_.find(t.commits,s);return a.commits[e]},t.firstRenderedCommit=function(){if(r)return null;var e=i();return e.reduce(function(e,t){var r=t.firstVisible();return r&&(!e||e.orderNr<r.orderNr)?r:e},null)},t.lastRenderedCommit=function(){if(r)return null;var e=i();return e.reduce(function(e,t){var r=t.lastVisible();return!e||e.orderNr>r.orderNr?r:e},null)},t.finallyMergesToColumn=function(){var e=this.lastVisible();if(!e)return null;var t=e.children;if(0===t.length)return null;var r=a.columns[a.commits[t[0]].columns[0]];return r}}function n(e,t){var r=this;e=e||C;var n=e.length()+1,a=0;r.setStepScore=function(e){a=e},r.members={},r.members.prototype=e.members,r.members[t]=!0,r.last=function(){return t};var i=null;return r.score=function(){return null===i&&(i=e.score()),i+a},r.length=function(){return n},r.asArray=function(){var r=e.asArray().slice(0);return r.push(t),r},r.contains=function(e){return e in r.members},r}var a,i={},s={style:"none",root:null},o={rowHeight:35},l={DEBUG:"DEBUG",INFO:"INFO",WARN:"WARN",ERROR:"ERROR"},c={},u=CryptoJS.MD5,m={drawElem:null,masterRef:"refs/heads/master",developRef:"refs/heads/develop",featurePrefix:"refs/heads/feature/",releasePrefix:"refs/heads/release/",hotfixPrefix:"refs/heads/hotfix/",releaseZonePattern:/^refs\/heads\/bugfix/,releaseTagPattern:/^refs\/tags\/\d+(\.\d+)+$/,showSpinner:function(){},hideSpinner:function(){},dataCallback:function(e){c.dataCallback||(console.log(l.WARN,"The required option 'dataCallback' is missing, please provide a method to retrieve commit data"),c.dataCallback=!0),e({})},moreDataCallback:function(e,t){c.moreDataCallback||(console.log(l.WARN,"The required option 'moreDataCallback' is missing, please provide a method to retrieve commit data"),c.moreDataCallback=!0),t({})},dataProcessed:function(){},log:function(e,t){},createCommitUrl:function(){return"#"},createAuthorAvatarUrl:_.memoize(function(e){return"https://secure.gravatar.com/avatar/"+u(e.emailAddress)+".jpg?s=48&amp;d=mm"},function(e){return e.emailAddress}),hiddenBranches:[]},d=function(t){var r={};if(a=r,r.commits={},r.openEnds={},!t.commits||!t.branches||!t.tags)throw"raw data should have a commits, branches and  tags property";for(var n=0;n<t.commits.length;n++)for(var s=0;s<t.commits[n].values.length;s++){var o=t.commits[n].values[s];delete o.columns,delete o.labels,delete o.orderTimestamp,delete o.children,r.commits[o.id]=o}for(var c in r.commits){var o=r.commits[c];o.orderTimestamp=o.authorTimestamp,o.children||(o.children=[]);for(var n=o.parents.length-1;n>=0;n--){var u=r.commits[o.parents[n].id];u?f(u,o.id):(r.openEnds[o.id]=r.openEnds[o.id]||[],r.openEnds[o.id].push(o.parents[n].id))}}r.branches=_.filter(t.branches.values,function(e){return m.hiddenBranches.indexOf(e.id)===-1}),r.hiddenBranches=_.filter(t.branches.values,function(e){return m.hiddenBranches.indexOf(e.id)>-1}),e(r);var d=function(e,t){if(e&&e.orderTimestamp<=t){m.log(l.DEBUG,"fixing orderTimestamp for "+e.displayId+" "+e.orderTimestamp+" -> "+t+1),e.orderTimestamp=t+1;for(var n=0;n<e.children.length;n++)d(r.commits[e.children[n]],e.orderTimestamp)}};for(var h in r.commits)for(var g=r.commits[h],v=0;v<g.parents.length;v++){var u=r.commits[g.parents[v].id];u&&d(g,u.orderTimestamp)}r.tags=t.tags.values;for(var n=0;n<r.tags.length;n++){var b=r.tags[n],o=r.commits[b.latestChangeset];o&&(o.labels=o.labels||[],o.labels.push(b.id))}r.labels=r.tags.concat(r.branches),r.chronoCommits=[];for(var c in r.commits)r.chronoCommits.push(c);r.chronoCommits.sort(function(e,t){return r.commits[t].orderTimestamp-r.commits[e].orderTimestamp}),r.visibleCommits=[];for(var y=0,n=0;n<r.chronoCommits.length;n++){var o=r.commits[r.chronoCommits[n]];if(o.labels&&o.labels.length)o.visible=!0;else{var x=_.filter(_.map(o.children,function(e){return r.commits[e]}),function(e){return e.visible});o.visible=x.length>0}o.visible?(o.orderNr=y,r.visibleCommits.push(r.chronoCommits[n]),y++):delete o.orderNr}return p(r),r.openEnds.asap&&setTimeout(function(){i.drawing.lazyLoad()},1),r},f=function(e,t){e.children=e.children||[],e.children.push(t)},p=function(){h(),g(),v(),b(),y("d"),y("f"),y("r")},h=function(){var e=_.filter(a.branches,function(e){return e.id==m.masterRef});if(0!=e.length){for(var t=w(e[0].latestChangeset,_.map(_.filter(a.tags,function(e){return e.id.match(m.releaseTagPattern)}),function(e){return e.latestChangeset}),a),r=0;r<t.length;r++)x(t[r],"m",a);for(;;){var n=a.columns.m.commits,i=n[n.length-1],s=a.commits[i].parents;if(!s||0==s.length)break;if(!x(s[0].id,"m",a))break}}},g=function(){var e=_.filter(a.branches,function(e){return e.id==m.developRef});if(0!=e.length){for(var t=A(e[0].latestChangeset),r=0;r<t.length;r++)x(t[r],"d0",a);for(var n=m.developRef.substring(m.developRef.lastIndexOf("/")+1),i=new RegExp("Merge branch '[^']+' (of \\S+ )?into "+n+"$"),s=1,r=0;r<a.chronoCommits.length;r++){var o=a.commits[a.chronoCommits[r]];o.columns||i.test(o.message)&&(x(o.id,"d"+s),s++)}}},v=function(){for(var e=0,t=0;t<a.chronoCommits.length;t++){var r=a.commits[a.chronoCommits[t]];if(!r.columns){var n=_.filter(r.children,function(e){var t=a.commits[e],r=t.columns&&("m"==t.columns[0]||"d"==t.columns[0][0]);if(r)return!1;a.columns[t.columns[0]]||m.log(l.WARN,"huh");var n=a.columns[t.columns[0]].commits;return t.id==n[n.length-1]});if(0==n.length)x(r.id,"c"+e,a),e++;else{var i=a.commits[n[0]];i&&i.columns?(x(r.id,i.columns[0],a),i._hasColumnChild=!0):m.log(l.INFO,"Couldn't find appropriate parent")}}}},b=function(){for(var e=0;e<a.branches.length;e++){var t=a.branches[e];if(0===t.id.indexOf(m.releasePrefix)||0===t.id.indexOf(m.hotfixPrefix)||0===t.id.match(m.releaseZonePattern)){var r=a.commits[t.latestChangeset];if(r){var n=a.columns[r.columns[0]];"c"===n.name[0]&&(n.name="r"+n.name.substring(1))}}}for(var e=0;e<a.branches.length;e++){var t=a.branches[e];if(0===t.id.indexOf(m.featurePrefix)){var r=a.commits[t.latestChangeset];if(r){var n=a.columns[r.columns[0]];"c"===n.name[0]&&(n.name="f"+n.name.substring(1))}}}for(var i in a.columns){var n=a.columns[i];if("m"!=i&&"d"!=i[0]&&"r"!=i[0]){var s=_.flatMap(n.commits,function(e){return a.commits[e].children}),o=_.filter(s,function(e){var t=a.commits[e];return t.visible&&t.columns&&"m"==t.columns[0]});if(o.length>0)n.name="r"+n.name.substring(1);else{var l=_.flatMap(n.commits,function(e){return a.commits[e].parents}),c=_.filter(l,function(e){var t=a.commits[e.id];return!!t&&(t.visible&&t.columns&&"m"==t.columns[0])});if(c.length>0)n.name="r"+n.name.substring(1);else{var u=n.lastVisible();u&&(u.labels&&u.labels.filter(function(e){return 0==e.indexOf(m.releasePrefix)||0==e.indexOf(m.hotfixPrefix)||m.releaseZonePattern.test(e)}).length>0?n.name="r"+n.name.substring(1):u.labels&&u.labels.filter(function(e){return 0==e.indexOf(m.featurePrefix)}).length>0&&(n.name="f"+n.name.substring(1)))}}}}for(;;){for(var d=!1,f=_.filter(_.map(Object.keys(a.columns),function(e){return a.columns[e]}),function(e){return"c"==e.name[0]}),p=0;p<f.length;p++){var n=f[p],h=n.finallyMergesToColumn(),g=h?h.name[0]:"f";"c"!=g&&("d"==g&&(g="f"),n.name=g+n.name.substring(1),d=!0)}if(!d)break}for(var v=_.filter(_.map(Object.keys(a.columns),function(e){return a.columns[e]}),function(e){return"f"==e.name[0]}),b=_.filter(v,function(e){return e.commits.length>9}),y=1,x=0;x<b.length;x++){var w=b[x];w.group=y,y++}for(var x=0;x<v.length;x++){var w=v[x],u=a.commits[w.commits[0]];if(u.children&&u.children.length>0){var C=a.columns[a.commits[u.children[0]].columns[0]];C.group&&(w.group=C.group)}else{var N=a.commits[w.commits[w.commits.length-1]];if(N.parents&&N.parents.length>0){var A=a.commits[N.parents[0].id];if(A){var E=a.columns[A.columns[0]];E.group&&(w.group=E.group)}}}}},y=function(e){for(var t=_.map(a.columns,function(e){return e}).filter(function(t){return t.name[0]==e}),r={},n=0;n<t.length;n++)t[n].group&&(r[t[n].group]=!0);r=Object.keys(r),r.unshift(null);for(var i=0;i<r.length;i++)for(var s=r[i],o=_.filter(t,function(e){return null===s?"undefined"==typeof e.group:e.group==s}),n=0;n<o.length;n++)for(var l=o[n],c=0;c<n;c++){var u=o[c];if(u.isVisible()){var m=u.firstRenderedCommit();m&&m.parents.length>0&&a.commits[m.parents[0].id]&&(m=a.commits[m.parents[0].id]);var d=l.lastRenderedCommit();d&&d.children.length>0&&a.commits[d.children[0]]&&(d=a.commits[d.children[0]]),(!d||!m||d.orderNr>=m.orderNr)&&(l.combine(u),c=n)}}},x=function(e,t){a.columns||(a.columns={}),t in a.columns||(a.columns[t]=new r(t));var n=a.commits[e];return!!n&&(n.columns=n.columns||[],n.columns.push(t),a.columns[t].commits.push(e),!0)},w=function(e,t){var r=function(e,r){return t.indexOf(r)>-1?1e3:-1},n=N(e,r);return n.asArray()},C={length:function(){return 0},score:function(){return 0},asArray:function(){return[]},contains:function(){return!1},members:{}},N=function(e,t){var r=t||function(){return-1},i=[],s={},o=a.commits[e];if(!o)return C;var l=new n(null,e),c=0;for(s[o.orderNr]=l,c=o.orderNr,i.push(l);i.length>0;)for(var u=i.shift(),m=a.commits[u.last()],d=0;d<m.parents.length;d++){var f=a.commits[m.parents[d].id];if(f){var p=r(u,f.id);if(p!==!1&&!(s[f.orderNr]&&s[f.orderNr].score()>u.score()+p)){var h=new n(u,f.id);h.setStepScore(p),i.push(h),s[f.orderNr]=h,c<f.orderNr&&(c=f.orderNr)}}}var g=Object.keys(s);return g.sort(function(e,t){return e&&t?s[t].score()-s[e].score():0}),s[g[0]]},A=function(e){var t=m.developRef.substring(m.developRef.lastIndexOf("/")+1),r=m.releasePrefix.split("/")[2],n=m.hotfixPrefix.split("/")[2],i=new RegExp("Merge branch '("+t+")' of http:\\/\\/\\S+ into \\1"),s=new RegExp("Merge branch '[^']+' into "+t+"$"),o=new RegExp("Merge branch '("+r+"|"+n+")[^']+' into "+t+"\\b"),l=function(e,t){var r=a.commits[t],n=a.commits[e.last()];if(r.columns&&"m"==r.columns[0])return!1;var l=r.children.filter(function(t){return e.contains(t)});return 1==l.length&&(i.test(r.message)?0:o.test(r.message)?20:s.test(r.message)?5:n.parents.length>1&&r.id==n.parents[0].id?1:-.1)},c=N(e,l);return c.asArray()};i.state=function(){var e=JSON.stringify(E);return e};var E=null,O={commits:!0,labels:!0},T=[];i.draw=function(e,t){if(e)try{e instanceof HTMLElement||(t=e,e=null)}catch(r){"object"==typeof e&&1===e.nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument||(t=e,e=null)}m=_.extend(m,t),m.drawElem=m.drawElem||e,m.drawElem?m.drawElem instanceof d3.selection||(m.drawElem=d3.select(m.drawElem)):m.drawElem=d3.select("body").append("div").attr("id","gitflow-visualize"),m.showSpinner(),m.dataCallback(function(e){E=e,m.hideSpinner(),z()})};var k=function(e){var t=_.filter(e,function(e){return!(e in a.commits)});t.length>0&&(E.commits.push(e),O.commits=!0)},D=function(e){var t=E.branches.values.reduce(function(e,t){return e[t.id]=t,e},{}),r=!1;return e.values.forEach(function(e){var n=e.id;!(e.latestChangeset in a.commits),n in t?t[n].latestChangeset!==e.latestChangeset&&(r=!0,t[n].latestChangeset=e.latestChangeset):(E.branches.values.push(e),r=!0)}),r&&(O.labels=!0),r},R=function(){m.log(l.INFO,"Starting mini draw"),t(),m.drawElem&&(i.drawing.drawGraph(m.drawElem),i.drawing.updateHighlight())},z=function(){m.showSpinner(),a=setTimeout(function(){m.log(l.INFO,"Starting full new draw"),d(E),O.commits=!1,O.labels=!1,m.log(l.INFO,"Done cleaning/transforming data"),m.hideSpinner(),m.dataProcessed(a),m.drawElem&&i.drawing.drawUI(m.drawElem),m.log(l.INFO,"Done drawing (animations still in progress)")},10)};return i.drawing=function(){function e(e){var t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}var t={};t.updateHighlight=function(){var e=function(e){if(!e||0==e.length)return d3.selectAll(".commit-msg").classed("dim",!1).classed("highlight",!1),d3.selectAll(".commit-dot").classed("dim",!1),void d3.selectAll(".arrow").style("opacity","1");for(var t in a.commits)e.indexOf(t)>-1?(d3.selectAll("#msg-"+t).classed("dim",!1).classed("highlight",!0),d3.selectAll("#commit-"+t).classed("dim",!1),d3.selectAll(".arrow-to-"+t).style("opacity","1")):(d3.selectAll("#msg-"+t).classed("dim",!0).classed("highlight",!1),d3.selectAll("#commit-"+t).classed("dim",!0),d3.selectAll(".arrow-to-"+t).style("opacity","0.2"))};switch(d3.selectAll(".commit-msg.selected").classed("selected",!1),s.style){case"none":e([]);break;case"ancestry":var t=d3.select("#msg-"+s.root),r={},n=function(e){var t=a.commits[e];if(t&&!r[e]){r[e]=!0;for(var i=0;i<t.parents.length;i++)n(t.parents[i].id)}};t.classed("selected",!0),n(s.root),e(Object.keys(r))}};var r=function(e){var t=_.map(e,function(e,t){return t});return t.sort(firstBy(function(t,r){var n=function(t){return{m:1,d:3,f:4,r:2}[e[t].name[0]]||5};return n(t)-n(r)}).thenBy(function(e,t){return(a.columns[e].group||0)-(a.columns[t].group||0)}).thenBy(function(e,t){if("f"==a.columns[e].name[0]){var r=a.columns[e].commits,n=a.columns[t].commits;return a.commits[r[0]].orderNr-a.commits[n[0]].orderNr}return t>e?-1:1})),t},n=function(e,t){for(var r={gutter:.7,line:1,developLine:.4},n={},i="",s=0,o={},l=0;l<e.length;l++){var c=e[l],u=a.columns[c];if(u.isVisible()){var m=c[0];i!=m&&(s+=r.gutter),s+="d"==m?r.developLine:r.line,o[c]=s,i=m}else n[c]=u.renderPos()}var d=d3.scale.linear().domain([0,s]).range([0,Math.min(t,20*s)]);return function(e){var t=0;return"+"==e[e.length-1]&&(e=e.substring(0,e.length-1),t=.5),e in n&&(e=n[e]),d(o[e]+t)}};t.drawUI=function(e){var r=Math.max(800,a.visibleCommits.length*o.rowHeight),n={width:500,height:r},i=20,s=e.select(".commits-graph-container");if(s.empty()){s=e.append("div").attr("class","commits-graph-container"),s.append("div").attr("class","scroll-container").append("div").attr("class","scrollme"),s.select("div.scrollme").style("width",n.width+2*i+"px");var l=s,c=s.select(".scroll-container");l.on("scroll",function(){c.node().scrollLeft=l.node().scrollLeft}),c.on("scroll",function(){l.node().scrollLeft=c.node().scrollLeft})}var u=s.select("div.group");u.empty()&&(u=s.append("div").attr("class","group"));var m=u.select("div.graph-container");m.empty()&&(m=u.append("div").attr("class","group-item graph-container"));var d=u.select("div.gutter");if(d.empty()){var f=!1,p=function(){"dblclick"===d3.event.type?m.style("width",d.style("width")):"mousedown"===d3.event.type?f||(f=!0):f&&(m.style("width",d3.event.pageX+"px"),"mouseup"===d3.event.type&&(f=!1)),d3.event.stopPropagation(),d3.event.preventDefault()};d=u.append("div").attr("class","gutter").style("height",n.height+"px").on("mousedown",p).on("dblclick",p).append("div").attr("class","gutterline"),d3.select("body").on("mouseup",p),d3.select("body").on("mousemove",p)}var h=u.select("div.commits-container");h.empty()&&(h=u.append("div").attr("class","group-item commits-container")),t.drawGraph(m),t.drawTable(h),t.updateHighlight()},t.drawTable=function(e){var t=e.select("table");t.empty()&&(t=e.append("table").attr("class","commits-table"));var r=t.select("thead tr");if(r.empty()){var r=t.append("thead").append("tr");r.append("th").text("commit"),r.append("th").text("message"),r.append("th").text("author"),r.append("th").text("date")}var n=t.select("tbody");n.empty()&&(n=t.append("tbody")),n.selectAll("tr.commit").remove();var i=n.selectAll("tr.commit").data(d3.values(a.commits).filter(function(e){return e.visible}),function(e){return"msg-"+e.id+"-"+moment().format("YYMMDD")}),s=i.enter().append("tr").sort(function(e,t){return e.orderNr==t.orderNr?0:e.orderNr<t.orderNr?-1:1}).attr("class","commit").attr("id",function(e){return"msg-"+e.id}).attr("data-orderNr",function(e){return e.orderNr});s.append("td").attr("class","hash").append("a").attr("class","commit-link").attr("href",function(e){return m.createCommitUrl(e)}).text(function(e){return e.displayId});var o=s.append("td").attr("class","message").append("div").attr("class","flex-content");o.append("div").attr("class","flex-content--primary").append("span").attr("class","body").text(function(e){return e.message}),o.append("div").attr("class","flex-content--secondary").append(function(e){var t=document.createElement("div");return t.setAttribute("class","labels"),_.each(e.labels||[],function(e){var r=document.createElement("span");0==e.indexOf("refs/heads/")?0==e.indexOf(m.masterRef)?(r.setAttribute("class","label aui-lozenge aui-lozenge-error aui-lozenge-subtle"),r.appendChild(document.createTextNode(e.substring(11)))):0==e.indexOf(m.developRef)?(r.setAttribute("class","label aui-lozenge aui-lozenge-success aui-lozenge-subtle"),r.appendChild(document.createTextNode(e.substring(11)))):0==e.indexOf(m.featurePrefix)?(r.setAttribute("class","label aui-lozenge aui-lozenge-complete aui-lozenge-subtle"),r.appendChild(document.createTextNode(e.substring(11)))):0==e.indexOf(m.releasePrefix)||0==e.indexOf(m.hotfixPrefix)?(r.setAttribute("class","label aui-lozenge aui-lozenge-current aui-lozenge-subtle"),r.appendChild(document.createTextNode(e.substring(11)))):(r.setAttribute("class","label aui-lozenge aui-lozenge-subtle"),r.appendChild(document.createTextNode(e.substring(11)))):0==e.indexOf("refs/tags/")&&(r.setAttribute("class","label aui-lozenge aui-lozenge-moved aui-lozenge-subtle"),r.appendChild(document.createTextNode(e.substring(10)))),t.appendChild(r)}),t});var l=s.append("td").attr("class","author").append("span").attr("class","author").style("display",function(e){return e.author?"":"none"});l.append("span").attr("class","thumbnail").append("img").attr("src",function(e){return e.author?m.createAuthorAvatarUrl(e.author):""}),l.append("span").attr("class","author").attr("title",function(e){return e.author.displayName||e.author.name||e.author.emailAddress}).text(function(e){return e.author.displayName||e.author.name||e.author.emailAddress}),s.append("td").attr("class","date").attr("title",function(e){if(e.authorTimestamp){var t=new Date(e.authorTimestamp);return moment(t).format("YYYY-MM-DD")}}).text(function(e){if(e.authorTimestamp){var t=new Date(e.authorTimestamp),r=(new Date).toDateString()===t.toDateString();return r?moment(t).format("HH:mm:ss")+" today":moment(t).format("YYYY-MM-DD")}}),i.exit().remove()},t.drawGraph=function(e){var t=Math.max(800,a.visibleCommits.length*o.rowHeight),i={width:500,height:t},s=20,l=e.select("svg>g");if(l.empty())var l=e.append("svg").attr("class","commits-graph").append("g").attr("transform","translate("+s+",0)"),c=l.append("g").attr("id","bgLayer"),m=l.append("g").attr("id","arrowsLayer"),d=l.append("g").attr("id","mainLinesLayer"),f=l.append("g").attr("id","commitsLayer");e.select("svg").attr("width",i.width+2*s).attr("height",i.height+2*s),c=l.select("g#bgLayer"),m=l.select("g#arrowsLayer"),d=l.select("g#mainLinesLayer"),f=l.select("g#commitsLayer");var p=r(a.columns),h={master:{prefix:"m"},releases:{prefix:"r"},develop:{prefix:"d"},features:{prefix:"f"}};for(var g in h){var v=p.filter(function(e){return a.columns[e].name[0]===h[g].prefix});0!=v.length?(h[g].first=v[0],h[g].last=v[v.length-1]):delete h[g]}var b=n(p,i.width,a.columnMappings),y=d3.scale.linear().domain([0,a.visibleCommits.length]).range([60,60+a.visibleCommits.length*o.rowHeight]),x=d3.svg.line().x(function(e){return b(e.x)}).y(function(e){return y(e.y)}),w=function(e){var t=a.commits[e.c],r=a.commits[e.p];if(!t||!r||!t.visible)return null;var n=r.orderNr-.5,i=t.columns[0],s=null,o=null,l=a.columns[t.columns[0]];if(!l)return null;var c=a.columns[r.columns[0]];if(l.id!=c.id){var u=c.commits[c.commits.indexOf(r.id)-1];if(!u||a.commits[u].orderNr<t.orderNr)n=t.orderNr+.5,i=r.columns[0];else{var m=l.commits[l.commits.indexOf(t.id)+1];!m||a.commits[m].orderNr>r.orderNr||(o=t.columns[0]+"+",s=r.orderNr-.5,i=t.columns[0]+"+",n=t.orderNr+.5)}}o||(o=i),s||(s=n);var d=[{x:t.columns[0],y:t.orderNr},{x:i,y:n},{x:o,y:s},{x:r.columns[0],y:r.orderNr}];return x(d)},C=_.flatMap(d3.values(a.commits).filter(function(e){return e.visible}),function(e){return e.parents.map(function(t){return{p:t.id,c:e.id}})}),N=m.selectAll(".arrow").data(C,function(e){return"a-"+e.p+"-"+e.c}),A=N.enter().append("g").attr("class",function(e){return"arrow arrow-to-"+e.c});A.append("path").attr("stroke-linejoin","round").attr("class","outline"),A.append("path").attr("stroke-linejoin","round").attr("class",function(e){return"branch-type-"+u(e.c,e.p)});var E=N.selectAll("g>path");E.transition().duration(800).attr("d",w),N.exit().remove();var O=c.selectAll(".branch").data(d3.values(a.columns).filter(function(e){return e.isVisible()}));O.enter().append("g").attr("class","branch").append("line"),O.select("g>line").transition().attr("class",function(e){return"branch-line "+e.name}).attr("x1",function(e){return b(e.id)}).attr("x2",function(e){return b(e.id)}).attr("y1",y(0)).attr("y2",i.height),O.exit().remove();var O=d.selectAll(".branch").data(d3.values(a.columns).filter(function(e){return e.isVisible()&&("d0"===e.id||"m"===e.id)}));O.enter().append("g").attr("class","branch").append("line"),O.select("g>line").transition().attr("class",function(e){return"branch-line "+e.name}).attr("x1",function(e){return b(e.id)}).attr("x2",function(e){return b(e.id)}).attr("y1",y(0)).attr("y2",i.height);var T=f.selectAll(".commit").data(d3.values(a.commits).filter(function(e){return e.visible}),function(e){return"c-"+e.id});T.enter().append("g").attr("class","commit").attr("data-orderNr",function(e){return e.orderNr}).append("circle").attr("class","commit-dot").attr("r",5).append("svg:title").text(function(e){return e.displayId}),T.exit().remove(),T.select("g>circle").transition().duration(800).attr("cx",function(e){return b(e.columns[0])}).attr("cy",function(e){return y(e.orderNr)}).attr("id",function(e){return"commit-"+e.id});var k=c.selectAll(".legenda-label").data(Object.keys(h)),D=k.enter(),R=D.append("g").attr("class",function(e){return"legenda-label "+h[e].prefix}).append("g").attr("transform",function(e){var t=h[e].first==h[e].last?-10:0;return"translate("+(b(h[e].first)+t)+", "+(y(0)-20)+") rotate(-40)"});R.append("rect").attr("width",60).attr("height",15).attr("rx","2"),R.append("text").attr("y","12").attr("x","3").text(function(e){return e}),k.select("g").transition().attr("transform",function(e){var t=h[e].first==h[e].last?-10:0;return"translate("+(b(h[e].first)+t)+", "+(y(0)-20)+") rotate(-40)"})};var i={},c={};t.lazyLoad=function(){var t=null;if(a&&a.openEnds)for(var r in a.openEnds){if("asap"===r){t=r;break}var n=d3.select("#msg-"+r);if(!n.empty()&&e(n.node())){t=r;break}}if(t){var s="asap"===t?0:a.commits[t].orderNr;for(var r in a.openEnds){var o="asap"===r?0:a.commits[r].orderNr;if(!(o>s+200)){for(var u=0;u<a.openEnds[r].length;u++){var d=a.openEnds[r][u];T.indexOf(d)===-1&&(i[d]=!0,m.log(l.DEBUG,"scheduled: "+d))}delete a.openEnds[r]}}for(var r in i)m.log(l.DEBUG,"downloading: "+r),delete i[r],c[r]=!0,m.moreDataCallback(r,function(e,t){delete c[t],T.push(t),e&&k(e),0==Object.keys(i).length&&0==Object.keys(c).length?O.commits?(m.log(l.DEBUG,"queues empty, ready to draw"),setTimeout(function(){m.log(l.DEBUG,"start drawing"),z()},50)):m.log(l.DEBUG,"no new commits loaded, no need to redraw"):m.log(l.DEBUG,"waiting, still downloads in progress")});i={}}};var u=function(e,t){var r=function(e){var t=a.commits[e];if(!t||0==a.columns.length)return"?";var r=t.columns.map(function(e){return a.columns[e]});return r[0].name[0]},n={m:0,d:1,r:3,f:2},i=[r(e),r(t)];return"d"===i[0]&&"d"!==i[1]?i[1]+" back":(i.sort(function(e,t){return n[t]-n[e]}),i[0]||"default")};return t}(),i.branches={setHidden:function(e){if(!(e instanceof Array))throw"pass in refs as an array of strings with full ref descriptors of the branches to hide (like 'refs/heads/develop')";m.hiddenBranches=e,z()},setChanged:function(e){D(e)&&(R(),i.drawing.lazyLoad())},getHidden:function(){return m.hiddenBranches},getAll:function(){return _.map(a.branches.concat(a.hiddenBranches),function(e){return{id:e.id,name:e.displayId,lastActivity:e.lastActivity,lastActivityFormatted:moment(e.lastActivity).format("M/D/YY HH:mm:ss"),visible:m.hiddenBranches.indexOf(e.id)===-1}})},registerHandler:function(e){}},document&&(d3.select(document).on("scroll",function(){GitFlowVisualize.drawing.lazyLoad()}).on("resize",function(){GitFlowVisualize.drawing.lazyLoad()}),d3.select(document).on("keydown",function(){var e=d3.event;if(e.ctrlKey&&e.shiftKey&&221==e.which){var t=d3.select("#debug-output");t.empty()&&(t=d3.select("body").append("textarea").attr("id","debug-output")),t.style("display",""),t.node().value=GitFlowVisualize.state(),t.node().focus(),t.node().select(),t.on("blur",function(){t.style("display","none")})}})),i}();